<!DOCTYPE html>
<html>
<head>
<title>
{% block title%}
{% endblock %}
初始化| Wolf设备管理系统</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="/static/img/favicon.ico" type="image/x-icon" />
<!-- Bootstrap core CSS -->
<link href="/static/css/bootstrap.min.css" rel="stylesheet">
<link href="/static/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
<link href="/static/css/app.css" rel="stylesheet">
<link href="/static/css/acc-wizard.min.css" rel="stylesheet">
<style type="text/css">
    ol.acc-wizard-sidebar li.active > a{
        font-size: 16px;
        color:#50a2a6
    }

    ol.acc-wizard-sidebar li.active:before{
        background:#50a2a6
    }

    ol.acc-wizard-sidebar li.success > a{
        font-size: 16px;
        color:#08c
    }

    ol.acc-wizard-sidebar li.success:before{
        background:#08c
    }

    .logo {
    width: 40px;
    height: 40px;
    float: left;
    margin-right: 20px;
    margin:10px;
    background-image: url(/static/img/BFS_logo.gif);
    }
</style>
</head>

<body style='background-image: url(/static/img/back3.jpg); background-size:cover;' onload="AlertFunc()">
    <input id="AlertInfo" value="{{AlertInfo}}" type="hidden">
    <nav class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="logo" href="/base"></a>
                <a class="navbar-brand" href="/">DMS设备管理系统</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="javascript:void(0)" class="init">重新初始化系统</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">帮助<span class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="/help2">关于DMS设备管理系统</a></li>
                            </ul>
                     </li>
                     <li><a href="/logout" name="submit" onclick="document.getElementById('subform').submit();return false">退出</a></li>
                </ul>   
            </div>
        </div>        
    </nav>

   <div class="container-fluid">
        <div class="row">
            <div class="col-md-3" style="padding-left: 2em;">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            初始化向导
                        </h4>
                    </div>
                    <div class="panel-body">
                        <p style="margin-bottom: 2em;">
                          请按照以下向导完成DMS设备管理系统初始化.
                        </p>
                        <ol class="acc-wizard-sidebar">
                            {% if count == 0 %}
                            <li class="active"><a href="/initial1"><strong>添加前置机</strong></a></li>
                            {% elif count >=1 %}
                            <li class="success"><a href="/initial1">添加前置机<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                            {% endif %}

                            {% if count >=1 %}
                                {% if count <4 %}
                                <li class="active"><a href="/initial2"><strong>初始化前置机</strong></a></li> 
                                {% elif count >=4 %}
                                <li class="success"><a href="/initial2">初始化前置机<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>初始化前置机</a></li>
                            {% endif %} 

                            {% if count >=4 %}
                                {% if count <5 %}
                                <li class="active"><a href="/initial3"><strong>配置前置机网口IP</strong></a></li>
                                {% else %} 
                                <li class="success"><a href="/initial3">配置前置机网口IP<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>配置前置机网口IP</a></li>
                            {% endif %}

                            {% if count >=5 %}
                                {% if count <6 %}
                                <li class="active"><a href="/initial4"><strong>配置前置机路由</strong></a></li>
                                {% else %}
                                <li class="success"><a href="/initial4">配置前置机路由<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>配置前置机路由</a></li>
                            {% endif %}

                            {% if count >=6 %}
                                {% if count <7 %}
                                <li class="active"><a href="/initial5"><strong>导入CA根证书</strong></a></li>
                                {% else %}
                                <li class="success"><a href="/initial5">导入CA根证书<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>导入CA根证书</a></li>
                            {% endif %}

                            {% if count >=7 %}
                                {% if count <8 %}
                                <li class="active"><a href="/initial6"><strong>导入管理系统公钥证书</strong></a></li>
                                {% else %}
                                <li class="success"><a href="/initial6">导入管理系统公钥证书<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>导入管理系统公钥证书</a></li>
                            {% endif %}

                            {% if count >=8 %}
                                {% if count <10 %}
                                <li class="active"><a href="/initial8"><strong>注册初始用户</strong></a></li>
                                {% else %}
                                <li class="success"><a href="/initial8">注册初始用户<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>注册初始用户</a></li>
                            {% endif %}
                        </ol>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="div-confirm" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="exampleModalLabel">确认重新初始化系统</h4>
                        </div>
                        <form method="POST" action="/reinitialize" enctype="multipart/form-data">
                            <div class="panel-body">
                                <input name='nonce' type='hidden' value="{{ nonce }}">
                                <div class="form-group">
                                    <label class="control-label">输入超级用户密码：</label>
                                    <input type="hidden" name="epassword" id="epassword">
                                    <input type="password" name="adminpassword" id="adminpassword" class="form-control host-input" required>
                                </div>
                            </div>
                            <div class="panel-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                <button id="div-btn-confirm" type="submit" class="btn btn-primary">确认</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <div class="modal fade " id="div-import" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="panel panel-primary" id="div-import">
                            <div class="panel-heading">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h3 class="panel-title">导入公钥证书</h3>
                            </div>
                            <div class="panel-body">
                                <form action="/initial8/exportukeycertfile" method="POST" enctype="multipart/form-data">
                                    <div class="form-group">
                                        <label class="control-label">证书文件</label>
                                        <input type="file" name="files[]" multiple="multiple"><br />
                                    </div>
                                    <div class="panel-footer">
                                        <button type="submit" class="btn btn-primary">完成</button>
                                        <button for="host" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                    </div>
                                </form>
                            </div>
                        </div>       
                    </div>
                </div>

                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">7、注册初始用户</h3>
                    </div>
                    <div class="panel-body"  id="createnewkey" >
                        <form method="POST" action=''>
                            <input name='nonce' type='hidden' value="{{ nonce }}">
                            <label class="control-label">请先创建一名系统管理员，创建过程中请保持USB Key插入状态</label>
                            <br/><br/>
                            <div align="center">
                                <div class="form-group">
                                    <label class="control-label">用&nbsp;&nbsp;户&nbsp;&nbsp;名</label>
                                    <input type="text" name="name" id="name" placeholder="name" required maxlength="30" >
                                </div>
                                <div class="form-group">
                                    <label class="control-label">口&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;令</label>
                                    <input type="password" name="password1" placeholder="Password" style="ime-mode:Disabled;" required title="1、口令长度不少于8位，不长于16位；" data-container="body" data-toggle="popover" data-placement="right" data-content="2、口令必须由数字、大小写字母、字符至少两种组成。" maxlength="16" id="pas1" >
                                </div>
                                <div class="form-group">
                                    <label class="control-label">确定口令</label>
                                    <input type="password" name="password2" placeholder="Password" style="ime-mode:Disabled;"  required="required" id="pas2">    
                                </div>
                                <div class="form-group" >
                                    <label class="control-label">权&nbsp;&nbsp;限：&nbsp;</label>
                                    <input type="text" name="style" value="系统管理员" readonly style="background-color:#b2b2b2";>
                                </div>
                                 <div class="form-group">
                                    <strong>国&nbsp;&nbsp;家：&nbsp;</strong>
                                    <input type="text" id="country" value="中国" readonly style="background-color:#b2b2b2"; >
                                </div>
                                <div class="form-group">
                                    <strong>省：</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                    <input type="text" id="province" placeholder="Province" required maxlength="8">
                                </div>
                                <div class="form-group">
                                    <strong>直&nbsp;辖&nbsp;市:</strong>
                                    <input type="text" id="city" placeholder="City" required maxlength="8">
                                </div>
                                <div class="form-group">
                                    <strong>组&nbsp;&nbsp;织：&nbsp;</strong>
                                    <input type="text" id="organ" placeholder="Organization" value="GDD" readonly style="background-color:#b2b2b2"; maxlength="8">
                                </div>
                                <div class="form-group">
                                    <strong>部&nbsp;&nbsp;门：&nbsp;</strong>
                                    <input type="text" id="depart" placeholder="Department" value="GDD" readonly style="background-color:#b2b2b2"; maxlength="8">
                                </div>
                                <div class="form-group">
                                    <strong>E-mail：</strong>
                                    <input type="email" id='email' placeholder='Email' required maxlength="16">
                                </div>  
                            </div><br/>                             
                            <div class="button-bar" align="center">
                                <button type="button" class="btn btn-primary" id="createkey">创建新用户</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                {% if count >=9 %}
                                <button type="button" class="btn btn-primary" id="inportcert">导入公钥证书</button>
                                {% else %}
                                <button type="button" class="btn btn-primary" id="inportcert" disabled >导入公钥证书</button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                    <br/>
                </div>
                <nav>
                    <ul class="pager">
                        <li><a href="/initial6" >上一步</a></li>
                        <a href="/finishinit"><button type="button" class="btn btn-primary active" {%if count < 10 %} disabled {% endif %} >完成初始化</button></a>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

</body>
</html>

{% block content %}
{% endblock %}
<script src="/static/js/jquery.min-1.11.2.js"></script>
<script src="/static/js/bootstrap.min.js"></script>
<script src="/static/js/enc.js"></script>

{% block scripts %}
<script type="text/javascript">

$('.init').click(function(){
    if(confirm("重新初始化系统会删除系统现在所有信息，你确定要重新初始化吗？")){
       $('#div-confirm').modal("toggle");
       } 
});

$('#div-btn-confirm').click(function(e){
    var b = document.getElementById('adminpassword').value
    var a = new Encrypt();  
    var str = a.encode(b);  
    $('#epassword').val(str)
    e.preventDefault();
    $.post($('#div-confirm form').attr('action'), $('#div-confirm form').serialize(), function(data){
        var data = $.parseJSON(JSON.stringify(data))
        if (data == "1"){
            window.location.href="/home"
        }else{
            alert("输入密码不正确，无法重新初始化系统！");
        }
    })
});

function SwitchStatusCode(data){
    switch(data)
    {
        case '-1': alert('ukey认证失败，请检查USB Key是否正确插入！'); break;
        case '16': alert('ukey未插入！'); break;
        case '32': alert('ukey未初始化，pin码！'); break;
        case '48': alert('ukey口令错误已达到8次！'); break;
        case '64': alert('ukey口令错误！'); break;
        case '80': alert('ukey的pin码未知,初始化失败！'); break;
        case '96': alert('获取ukey信息失败！'); break;
        case '112': alert('输入参数不合法！'); break;
        case '128': alert('输入ukey id与ukey自身的id不一致！'); break;
        case '144': alert('输入username与ukey中的username不一致！'); break;
        case '3': alert('两次输入的密码不一致，请重新输入！');break;
        case '2': alert('密码必须包含数字和字母两种类型，请重新输入！');break;
        case '0': alert('操作成功'); break;     
        case '-2': alert('请求超时'); break;
        case '-1': alert('返回数据包错误'); break;
        case '-3': alert('输入信息有误'); break;
        case '-4': alert('上传证书文件不正确'); break;        
        default: alert('操作异常');
    }
}


function AlertFunc()
{
    var info=document.getElementById("AlertInfo").value;
    if(info != "")
        alert(info);
    //alert("ajdflkjasdlj")
}

$(function () 
{ 
    $("[data-toggle='popover']").popover();
});


//-------------------createkey
$('#createkey').click(function(e){
    var name,pas1,pas2;
    name=document.getElementById("name").value;
    pas1=document.getElementById("pas1").value;
    pas2=document.getElementById("pas2").value;
    //country=document.getElementById("country").value;
    province=document.getElementById("province").value;
    city=document.getElementById("city").value;
    //organ=document.getElementById("organ").value;
    //depart=document.getElementById("depart").value;
    email=document.getElementById("email").value;
   // alert(name);alert(pas1);alert(pas2);
    if (name != "" && pas1 != "" && pas2 !=""){
        if(pas1.length<8){
                alert("密码必须大于8位，请重新输入！");
                return false;
            }
        if(!(pas1==pas2 && pas2!='')){
                alert("两次输入的密码不一致，请重新输入！");
                return false;
            }
        var i = 0;
        if(pas1.match(/.*[0-9]/) != null){
            i=i+1;
        }
        if(pas1.match(/.*[a-z]/) != null){
            i=i+1;
        }
        if(pas1.match(/.*[A-Z]/) != null){
            i=i+1;
        }
        if(pas1.match(/.*[~!@#$%^&*?]/) != null){
            i=i+1;
        }
        if( i <2 ){
            alert("口令必须由数字、大小写字母、特殊字符两种或两种以上组成，请重新输入！");
            return false;
            }
        var a = new Encrypt();  
        var str1 = a.encode(pas1);
        var str2 = a.encode(pas2);
        $.post("/initial8/initialusbkey",{
            name:name,
            password1:str1,
            password2:str2,
            //country:country,
            province:province,
            city:city,
            //organ:organ,
            //depart:depart,
            email:email,
            'nonce':'{{ nonce }}', 
          },function(data){
            var data = $.parseJSON(JSON.stringify(data))
            if (data.length > 5){
                window.location=data
                $("#inportcert").attr("disabled", false);
            }else{
                SwitchStatusCode(data)
            }
        })
    }else{
        alert("信息不完整，请输入完整信息！");
    }
});

$('#inportcert').click(function(e){
    $('#div-import').modal("toggle")
})



</script>
{% endblock %}
</body>
</html>