<!DOCTYPE html>
<html>
<head>
<title>
{% block title%}
{% endblock %}
初始化| Wolf设备管理系统</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="/static/img/favicon.ico" type="image/x-icon" />
<!-- Bootstrap core CSS -->
<link href="/static/css/bootstrap.min.css" rel="stylesheet">
<link href="/static/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
<link href="/static/css/app.css" rel="stylesheet">
<link href="/static/css/acc-wizard.min.css" rel="stylesheet">
<style type="text/css">
    ol.acc-wizard-sidebar li.active > a{
        font-size: 16px;
        color:#50a2a6
    }

    ol.acc-wizard-sidebar li.active:before{
        background:#50a2a6
    }

    ol.acc-wizard-sidebar li.success > a{
        font-size: 16px;
        color:#08c
    }

    ol.acc-wizard-sidebar li.success:before{
        background:#08c
    }

    .scrollspy2 {
    height:300px;
    overflow: auto;
    position: relative;
    }

    .logo {
    width: 40px;
    height: 40px;
    float: left;
    margin-right: 20px;
    margin:10px;
    background-image: url(/static/img/BFS_logo.gif);
    }
</style>
</head>

{% block content %}
<body style='background-image: url(/static/img/back3.jpg); background-size:cover;'>
    <nav class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="logo" href="/base"></a>
                <a class="navbar-brand" href="/">DMS设备管理系统</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="javascript:void(0)" class="init">重新初始化系统</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">帮助<span class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="/help2">关于DMS设备管理系统</a></li>
                            </ul>
                     </li>
                     <li><a href="/logout" name="submit" onclick="document.getElementById('subform').submit();return false">退出</a></li>
                </ul>   
            </div>
        </div>        
    </nav>
    
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3" style="padding-left: 2em;">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            初始化向导
                        </h4>
                    </div>
                    <div class="panel-body">
                        <p style="margin-bottom: 2em;">
                          请按照以下向导完成DMS设备管理系统初始化.
                        </p>
                        <ol class="acc-wizard-sidebar">
                            {% if count == 0 %}
                            <li class="active"><a href="/initial1"><strong>添加前置机</strong></a></li>
                            {% elif count >=1 %}
                            <li class="success"><a href="/initial1">添加前置机<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                            {% endif %}

                            {% if count >=1 %}
                                {% if count <4 %}
                                <li class="active"><a href="/initial2"><strong>初始化前置机</strong></a></li> 
                                {% elif count >=4 %}
                                <li class="success"><a href="/initial2">初始化前置机<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>初始化前置机</a></li>
                            {% endif %} 

                            {% if count >=4 %}
                                {% if count <5 %}
                                <li class="active"><a href="/initial3"><strong>配置前置机网口IP</strong></a></li>
                                {% else %} 
                                <li class="success"><a href="/initial3">配置前置机网口IP<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>配置前置机网口IP</a></li>
                            {% endif %}

                            {% if count >=5 %}
                                {% if count <6 %}
                                <li class="active"><a href="/initial4"><strong>配置前置机路由</strong></a></li>
                                {% else %}
                                <li class="success"><a href="/initial4">配置前置机路由<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>配置前置机路由</a></li>
                            {% endif %}

                            {% if count >=6 %}
                                {% if count <7 %}
                                <li class="active"><a href="/initial5"><strong>导入CA根证书</strong></a></li>
                                {% else %}
                                <li class="success"><a href="/initial5">导入CA根证书<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>导入CA根证书</a></li>
                            {% endif %}

                            {% if count >=7 %}
                                {% if count <8 %}
                                <li class="active"><a href="/initial6"><strong>导入管理系统公钥证书</strong></a></li>
                                {% else %}
                                <li class="success"><a href="/initial6">导入管理系统公钥证书<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>导入管理系统公钥证书</a></li>
                            {% endif %}

                            {% if count >=8 %}
                                {% if count <10 %}
                                <li class="active"><a href="/initial8"><strong>注册初始用户</strong></a></li>
                                {% else %}
                                <li class="success"><a href="/initial8">注册初始用户<i class="glyphicon glyphicon-ok" style="float:right;"></i></a></li>
                                {% endif %}
                            {% else %}
                                <li><a>注册初始用户</a></li>
                            {% endif %}
                        </ol>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="div-confirm" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="exampleModalLabel">确认重新初始化系统</h4>
                        </div>
                        <form method="POST" action="/reinitialize" enctype="multipart/form-data">
                            <div class="panel-body">
                                <input name='nonce' type='hidden' value="{{ nonce }}">
                                <div class="form-group">
                                    <label class="control-label">输入超级用户密码：</label>
                                    <input type="hidden" name="epassword" id="epassword">
                                    <input type="password" name="adminpassword" id="adminpassword" class="form-control host-input" required>
                                </div>
                            </div>
                            <div class="panel-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                <button id="div-btn-confirm" type="submit" class="btn btn-primary">确认</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">4、配置和查看前置机路由</h3>
                    </div>
                    <div class="panel-body" id="configroute" align="center">
                        <form method="POST" action='' id="setroute">
                            <input type='hidden' name='nonce' value='{{ nonce }}'>
                            <p>
                                IP&nbsp;地址:
                                <input type="text" name="rip" id="rip" value="{{rip}}" onkeyup="value=value.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,'')">
                            </p>
                            <p>
                                掩&nbsp;&nbsp;&nbsp;&nbsp;码:
                                <input type="text" name="mask" id="mask" value="{{mask}}" onkeyup="value=value.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,'')">
                            </p> 
                            <p>
                                网&nbsp;&nbsp;&nbsp;&nbsp;关:
                                <input type="text" name="gateway" id="gateway" value="{{ gateway }}" onkeyup="value=value.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,'')">
                            </p>
                            <p>
                                <input type="radio" name="interface" id="interface" value="0" checked/>外网1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <input type="radio" name="interface" id="interface" value="1" />外网2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <input type="radio" name="interface" id="interface" value="2" />外网3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <input type="radio" name="interface" id="interface" value="3" />外网4
                            </p>  
                            <p>
                                <input type="radio" name="style" value="1" checked/> 主机路由
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="style" value="0" /> 网络路由
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="style" value="2" /> 默认路由
                            </p>
                            <br/>
                            <div class="button-bar" align="center">
                                {% if routecount >= 16 %}
                                <button type="button" class="btn btn-primary" id="configlmroute" disabled>添加路由</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                {% else %}
                                <button type="button" class="btn btn-primary" id="configlmroute">添加路由</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                {% endif %}
                                <button type="button" id="div-btn-deleteroute" class="btn btn-primary">删除路由</button>
                            </div>
                        </form>                                                             
                    </div>
                    <div class="scrollspy2">
                        <table class="table table-bordered table-responsive " id="table1">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>IP地址</th>
                                    <th>掩码</th>
                                    <th>网关</th>
                                    <th>网口</th>
                                    <th>路由类型</th>
                                </tr>
                            </thead> 
                            <tbody>
                            {% for lmroute in lmroutes %}  
                            <tr style="overflow-x: auto;" onMouseOver="over()" onClick="change({{ loop.index }})" onMouseOut="out()">                 
                                <td>{{ loop.index }}</td>
                                <td class="Ipaddr">{{lmroute.IPAddr}}</td>
                                <td class="Mask">{{lmroute.Mask}}</td>
                                <td class="Gateway">{{lmroute.Gateway}}</td>
                                {% if lmroute.interface == "ixp1" %}
                                <td>网口1</td>
                                {% elif lmroute.interface == "ixp0" %}
                                <td>网口2</td>
                                {% elif lmroute.interface == "eth1" %}
                                <td>网口3</td>
                                {% elif lmroute.interface == "eth0" %}
                                <td>网口4</td>
                                {% endif %}
                                <td>{{lmroute.style}}</td>
                            </tr>
                               {% endfor %}
                            </tbody>
                        </table>
                    </div>  
                </div>  

                <nav>
                    <ul class="pager">
                        <li><a href="/initial3" >上一步</a></li>
                    {% if count >= 6 %}
                        <li><a href="/initial5">下一步</a></li>
                    {% else %}
                        <li><a style="color:#000;">下一步</a></li>    
                    {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>

{% endblock %}
<script src="/static/js/jquery.min-1.11.2.js"></script>
<script src="/static/js/bootstrap.min.js"></script>
<script src="/static/js/bootstrap-scrollspy.js"></script>
<script src="/static/js/enc.js"></script>

{% block scripts %}
<script type="text/javascript">
$('.init').click(function(){
    if(confirm("重新初始化系统会删除系统现在所有信息，你确定要重新初始化吗？")){
       $('#div-confirm').modal("toggle");
       } 
});

$('#div-btn-confirm').click(function(e){
    var b = document.getElementById('adminpassword').value
    var a = new Encrypt();  
    var str = a.encode(b);  
    $('#epassword').val(str)
    e.preventDefault();
    $.post($('#div-confirm form').attr('action'), $('#div-confirm form').serialize(), function(data){
        var data = $.parseJSON(JSON.stringify(data))
        if (data == "1"){
            window.location.href="/home"
        }else{
            alert("输入密码不正确，无法重新初始化系统！");
        }
    })
});



function SwitchStatusCode(data){
    switch(data)
    {
        case '1': alert('不存在该隧道'); break;
        case '2': alert('该隧道已存在'); break;
        case '3': alert('签名验证失败'); break;
        case "6": alert('解密出的明文数据不合法'); break;
        case '7': alert('该项操作当前被禁止'); break;
        case '8': alert('获取加密统计数据失败'); break;
        case '10': alert('添加隧道安全策略时失败'); break;
        case '11': alert('删除隧道安全策略时失败'); break;
        case '12': alert('重置装置失败'); break;
        case '13': alert('重置隧道失败'); break;
        case '14': alert('获取日志文件长度失败'); break;
        case '15': alert('读取日志文件失败'); break;
        case '17': alert('操作冲突'); break; 
        case '-2': alert('请求超时'); break;
        case '-1': alert('操作失败'); break;
        case '-3': alert('输入信息有误'); break;
        case '0': alert('操作成功'); break;                
        default: alert('操作异常');
    }
}

$('#configlmroute').click(function(e){
    var obj1 = document.getElementsByName("interface");
    var obj2 = document.getElementsByName("style");
    ip=document.getElementById('rip').value
    mask=document.getElementById('mask').value
    gateway=document.getElementById('gateway').value
    for(var i=0; i<obj1.length; i++){
        if(obj1[i].checked){
            interfacen = obj1[i].value;
            }
        }
    for(var j=0;j<obj2.length;j++){
        if(obj2[j].checked){
        style = obj2[j].value;
        }
    }
    if (ip != "" && mask !="" && gateway !=""){
        $.post('/initial4/setroute',{
        rip:ip,
        mask:mask,
        gateway:gateway,
        interface:interfacen,
        style:style,
        'nonce':'{{ nonce }}', 
        },function(data){
            var data = $.parseJSON(JSON.stringify(data))
            if (data == "0"){
                alert("操作成功！");
                location.reload();

            }else{
                SwitchStatusCode(data)
            }
        })
    }else{
        alert("请输入完整信息！");
    }
});

$('#div-btn-deleteroute').click(function(e){
    var obj1 = document.getElementsByName("interface");
    var obj2 = document.getElementsByName("style");
    ip=document.getElementById('rip').value
    mask=document.getElementById('mask').value
    gateway=document.getElementById('gateway').value
    for(var i=0; i<obj1.length; i++){
        if(obj1[i].checked){
            interfacen = obj1[i].value;
            }
        }
    for(var j=0;j<obj2.length;j++){
        if(obj2[j].checked){
        style = obj2[j].value;
        }
    }
    if (ip != "" && mask !="" && gateway !=""){
        $.post('/netset/deleteroute',{
        ip:ip,
        mask:mask,
        gateway:gateway,
        interfacen:interfacen,
        style:style,
        'nonce':'{{ nonce }}', 
        },function(data){
            var data = $.parseJSON(JSON.stringify(data))
            if (data == "0"){
                alert("操作成功！");
                location.reload();

            }else{
                SwitchStatusCode(data)
            }
        })
    }else{
        alert("请输入完整信息！");
    }
})

function findstrategynumber(id){
    var tab=document.getElementById("table1");
    ip = tab.rows[id].cells[1].innerHTML;
    mask = tab.rows[id].cells[2].innerHTML;
    gateway = tab.rows[id].cells[3].innerHTML;
    cinterface = tab.rows[id].cells[4].innerHTML;
    style = tab.rows[id].cells[5].innerHTML;
    document.getElementById("rip").value=ip;
    document.getElementById("mask").value=mask;
    document.getElementById("gateway").value=gateway;


    if (cinterface == "网口1"){
        var interfacevalue = document.getElementsByName("interface");
        for(i=0; i<interfacevalue.length; i++){
            if(interfacevalue[i].value==0){
                interfacevalue[i].checked = "checked";
            }
        }
    }else if(cinterface == "网口2"){
        var interfacevalue = document.getElementsByName("interface");
        for(i=0; i<interfacevalue.length; i++){
            if(interfacevalue[i].value==1){
                interfacevalue[i].checked = "checked";
            }
        }
    }else if(cinterface == "网口3"){
        var interfacevalue = document.getElementsByName("interface");
        for(i=0; i<interfacevalue.length; i++){
            if(interfacevalue[i].value==2){
                interfacevalue[i].checked = "checked";
            }
        }
    }else{
        var interfacevalue = document.getElementsByName("interface");
        for(i=0; i<interfacevalue.length; i++){
            if(interfacevalue[i].value==3){
                interfacevalue[i].checked = "checked";
            }
        }
    }

    if (style == "主机路由"){
        var stylevalue = document.getElementsByName("style");
        for(i=0; i<stylevalue.length; i++){
            if(stylevalue[i].value==1){
                stylevalue[i].checked = "checked";
            }
        }
    }else if(style == "网络路由"){
        var stylevalue = document.getElementsByName("style");
        for(i=0; i<stylevalue.length; i++){
            if(stylevalue[i].value==0){
                stylevalue[i].checked = "checked";
            }
        }
    }else{
        var stylevalue = document.getElementsByName("style");
        for(i=0; i<stylevalue.length; i++){
            if(stylevalue[i].value==2){
                stylevalue[i].checked = "checked";
            }
        }
    }
}


 //鼠标点击选择行时候变色
function change(change) {
    var oObj = window.event.srcElement;
    //alert(change.tagName.toLowerCase());
    if(oObj.tagName.toLowerCase() == "td"){   
        var oTr = oObj.parentNode;   
        for(var i=1; i<document.all.table1.rows.length; i++)   {   
            document.all.table1.rows[i].style.backgroundColor   =   "";   
            document.all.table1.rows[i].tag = false;   
        }
        oTr.style.backgroundColor = "#bce7e9";   
        oTr.tag = true;
        findstrategynumber(change);   
    }
}

//鼠标点击另外一行时关闭已选行变色
function out() {
    var oObj = event.srcElement;
    if(oObj.tagName.toLowerCase() == "td"){
        var oTr = oObj.parentNode;
        if(!oTr.tag) oTr.style.backgroundColor = "";
    }
}

//鼠标移动到选择行上时的行变色
function over(){   
    var oObj = event.srcElement;
    if(oObj.tagName.toLowerCase() == "td"){   
    var oTr = oObj.parentNode;
    if(!oTr.tag) oTr.style.backgroundColor = "#E1E9FD";
    }
}


</script>
{% endblock %}

</body>
</html>